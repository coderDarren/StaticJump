//Credits
//Sounds
//	SweetNeo85 - "Wilhelm Scream" @ freesound.org

using System;
using System.Collections.Generic;
using System.Diagnostics;
using Sce.PlayStation.Core;
using Sce.PlayStation.Core.Environment;
using Sce.PlayStation.Core.Graphics;
using Sce.PlayStation.Core.Input;
using Sce.PlayStation.Core.Audio;

namespace StaticJump
{
	public class AppMain
	{
		public static bool debug = true;
		
		private static GraphicsContext graphics;
		private enum GameState { Menu, Playing, Paused };
		private static GameState currState;
		private static int totalPlatforms; //difficulty guage
		
		private static Random randGen;
		private static int randCoordX;
		private static int randCoordY;
		private static int randNum;
		
		#region Sounds 
		
		private static SoundPlayer screamSP;
		
		#endregion
		
		
		
		
		#region Collections 
		
		private static List<Platform> platforms;
		private static List<Power> powers;
		private static List<Projectile> projectiles;
		
		#endregion
		
		
		
		#region Textures
		
		private static Texture2D platform1Tex;
		private static Texture2D platform1CrumbleTex;
		private static Texture2D power1Tex;
		private static Texture2D bg1Tex; //background
		private static Texture2D mg1Tex; //midground
		private static Texture2D playerTex;
		private static Texture2D attributeBarTex;
		private static Texture2D bulletTex;
		private static Texture2D enemyTex;
		private static Texture2D powBox1Tex;
		private static Texture2D hudBarTex;
		
		#endregion
		
		
		#region Menus
		
		private static MainMenu mainMenu;
		private static PauseMenu pauseMenu;
		
		#endregion
		
		
		#region Game Objects
		
		private static Platform platform;
		private static Power power;
		private static Background background;
		private static Background midground;
		private static Player player;
		private static Scoreboard scoreLabel;
		private static MaxChargePower pow1;
		
		#endregion
		
		
		
		#region Timers
		
		private static Stopwatch clock;
		private static long startTime;
		private static long stopTime;
		private static long deltaTime;
		private static long unpauseTimer; //used for only allowing one restart within some time
		private static long shootTimer; // used to determine how often the player can shoot
		private static long screamTimer; //used to only allow the screamSP to play once
		
		#endregion
		
		
		
		#region Counters
		
		private static int difficultyCounter; //used to determine when to increase difficulty
		
		#endregion
		
		
		
		#region UI
		
		private static PlayerAttribute playerJumpPowerBar;
		private static PlayerAttribute playerChargePowerBar;
		private static Sprite hudBar;
		
		#endregion
		
		
		public static void Main (string[] args)
		{
			Initialize ();

			while (true) {
				startTime = clock.ElapsedMilliseconds;
				SystemEvents.CheckEvents ();
				Update ();
				Render ();
				stopTime = clock.ElapsedMilliseconds;
				deltaTime = stopTime - startTime;
			}
		}
		
		
		
		#region Initialization
		
		public static void Initialize ()
		{
			// Set up the graphics system
			graphics = new GraphicsContext ();
			randGen = new Random();
			clock = new Stopwatch();
			clock.Start();
			mainMenu = new MainMenu(graphics);
			
			Sound scream;
			scream = new Sound("Application/Sounds/wilhelm_scream.wav");
			screamSP = scream.CreatePlayer();
			screamSP.Volume = 0.5f;
			
			currState = GameState.Menu;
		}
		
		private static void InitializeCollections()
		{
			platforms = new List<Platform>();
			powers = new List<Power>();
			projectiles = new List<Projectile>();
		}
		
		private static void InitializeTextures()
		{
			platform1Tex = new Texture2D("Application/Assets/platform1.png", false);
			//power1Tex = new Texture2D("Application/Assets/diamond.png", false);
			bg1Tex = new Texture2D("Application/Assets/background1.png", false);
			mg1Tex = new Texture2D("Application/Assets/midground1.png", false);
			playerTex = new Texture2D("Application/Assets/player_anim_sheet.png", false);
			attributeBarTex = new Texture2D("Application/Assets/attribute_bar.png", false);
			bulletTex = new Texture2D("Application/Assets/player_projectile_sheet.png", false);
			platform1CrumbleTex = new Texture2D("Application/Assets/platform1crumble.png",false);
			powBox1Tex = new Texture2D("Application/Assets/power_box1_sheet.png", false);
			hudBarTex = new Texture2D("Application/Assets/hudbar.png", false);
		}
		
		private static void InitializeObjects()
		{
			//Initially spawn enough for a double wide screen
			SpawnPlatforms(platform1Tex, totalPlatforms, 28, 150, graphics.Screen.Height - 100, 
			               (graphics.Screen.Width + graphics.Screen.Width / totalPlatforms) / totalPlatforms);
			SpawnPlatforms(platform1Tex, totalPlatforms-1, graphics.Screen.Width + 56, 150, graphics.Screen.Height - 100, 
			               (graphics.Screen.Width + graphics.Screen.Width / (totalPlatforms-1)) / (totalPlatforms-1));

			background = new Background(graphics, bg1Tex, 0.2f);
			midground = new Background(graphics, mg1Tex, 0.4f);
			player = new Player(graphics, new Vector3(platforms[3].Pos.X, platforms[3].Pos.Y - 80, 0), playerTex);
			scoreLabel = new Scoreboard(graphics);
			playerJumpPowerBar = new PlayerAttribute(graphics, new Vector3(graphics.Screen.Width / 2 + 300, graphics.Screen.Height - 24, 0), attributeBarTex);
			playerJumpPowerBar.SetAttributeBarColor(1.0f, 1.0f, 0.0f, 1.0f);
			playerChargePowerBar = new PlayerAttribute(graphics, new Vector3(graphics.Screen.Width / 2 - 300, graphics.Screen.Height - 24, 0), attributeBarTex);
			playerChargePowerBar.SetAttributeBarColor(0.0f, 1.0f, 1.0f, 1.0f);
			hudBar = new Sprite(graphics, hudBarTex);
			hudBar.Position = new Vector3(0, graphics.Screen.Height - 28, 0);
		}	
		
		private static void StartGame()
		{
			GC.Collect(); //Be sure all memory is deallocated before allocating more
			
			unpauseTimer = 0;
			shootTimer = 0;
			screamTimer = 0;
			totalPlatforms = 14;
			difficultyCounter = 0;
			
			InitializeCollections();
			InitializeTextures();
			InitializeObjects();
			
			currState = GameState.Playing;
		}
		
		#endregion
		
		
		
		#region Updating

		public static void Update ()
		{
			// Query gamepad for current state
			var gamePadData = GamePad.GetData (0);
			
			switch (currState)
			{
			case GameState.Menu: UpdateMenu(); break;	
			case GameState.Playing: UpdatePlaying(); break;
			case GameState.Paused: UpdatePaused(); break;
			}
		}
		
		private static void UpdateMenu()
		{
			mainMenu.Update(deltaTime);
			CheckMenuInput();
		}
		
		private static void UpdatePlaying()
		{
			foreach (Platform plat in platforms)
			{
				plat.Move();
				plat.UpdatePos();
			}
			player.Update(deltaTime);
			playerJumpPowerBar.UpdateAttribute(player.JumpPower, 1.0f);
			playerChargePowerBar.UpdateAttribute(player.JumpPower, 5.0f);
			UpdateProjectile();
			foreach (Projectile proj in projectiles)
			{
				proj.Update(deltaTime);
			}
			foreach (Power pow in powers)
			{
				pow.Update(deltaTime);	
			}
			UpdateDifficulty();
			background.UpdateBackground();
			midground.UpdateBackground();
			
			scoreLabel.UpdateScore(player.Score);
			
			if (player.Pos.Y > graphics.Screen.Height)
			{
				screamTimer += deltaTime;
				if (screamTimer < 50)
					screamSP.Play();
			}
			
			CheckCollisions();
			CheckForFallingPlatforms();
			CheckForExplodingPowers();
			CheckForDeadObjects();
			
			CheckPlayInput();
						
			Console.WriteLine(debug ? "Platforms On Screen: " + totalPlatforms : null);
			Console.WriteLine(debug ? "Projectiles On Screen: " + projectiles.Count : null);
		}
		
		
		private static void SpawnPlatforms(Texture2D tex, int numObjects, int minX, int minY, int maxY, float minXDist)
		{
			for (int i = 0; i < numObjects; i++)
			{
				Console.WriteLine(debug ? "Platform Separation: " + minXDist : null);
				randCoordY = randGen.Next(minY, maxY);
				platform = new Platform(graphics, new Vector3(minX + i * minXDist, randCoordY, 0), tex, "platform");
				platforms.Add(platform);
			}
			
		}
		
		private static void SpawnPowers()
		{
			randNum = randGen.Next(platforms.Count / 2, platforms.Count);
			pow1 = new MaxChargePower(graphics, new Vector3(platforms[randNum].Pos.X, platforms[randNum].Pos.Y - platforms[randNum].Extents.Height, 0), 
			                          powBox1Tex, "power1", platforms[platforms.Count-1].ScrollSpeed);
			powers.Add(pow1);
		}
		
		private static void UpdateDifficulty()
		{			
			if (difficultyCounter / totalPlatforms == 1)
			{
				if (totalPlatforms > 8)
				{
					totalPlatforms--;	
					SpawnPlatforms(platform1Tex, totalPlatforms, graphics.Screen.Width + 28, 150, graphics.Screen.Height - 100, (graphics.Screen.Width + graphics.Screen.Width / totalPlatforms) / totalPlatforms);
					SpawnPowers();
				}
				else //totalPlatforms needs to add 1 to conform with the range of the list in CheckForDeadObjects()
				{
					SpawnPlatforms(platform1Tex, totalPlatforms+1, graphics.Screen.Width + 28, 150, graphics.Screen.Height - 100, (graphics.Screen.Width + graphics.Screen.Width / totalPlatforms) / totalPlatforms);
					SpawnPowers();
				}
				
				difficultyCounter = 0;
			}
		}
		
		private static void CheckForFallingPlatforms()
		{
			var gamePadData = GamePad.GetData(0);
			
			foreach(Platform plat in platforms)
			{
				if (plat.WillFall &&
				   (gamePadData.Buttons & GamePadButtons.Cross) == 0)
				{
					plat.ChangeTexture(platform1CrumbleTex);
					plat.currState = Platform.State.Crumbling;
				}
			}
		}
		
		private static void CheckForExplodingPowers()
		{
			var gamePadData = GamePad.GetData(0);
			
			foreach(Power pow in powers)
			{
				if (pow.WillExplode)
				{
					pow.Explode();
				}
			}
		}
		
		private static void UpdateProjectile()
		{
			var gamePadData = GamePad.GetData(0);
			shootTimer += deltaTime;

			if ((gamePadData.Buttons & GamePadButtons.Square) != 0)
			{
				if (shootTimer > 500)
				{
				projectiles.Add(new Projectile (graphics, new Vector3(player.Pos.X, player.Pos.Y, 0), bulletTex, (int)player.dir));
				shootTimer = 0;
				}
			}
			Console.WriteLine(debug ? "Projectile Count: " +projectiles.Count : null);
		}
		
		private static void UpdatePaused()
		{
			pauseMenu.Update(deltaTime);
			CheckPauseInput();
		}
		
		#endregion
		
		
		
		
		
		
		#region Collision Testing
		
		private static void CheckCollisions()
		{			
			CheckPlayerCollisions();
			CheckBulletCollisions();
			CheckPowerCollisions();
		}
		
		private static void CheckPlayerCollisions()
		{
			//Player on platforms 
			
			foreach (Platform plat in platforms)
			{
				if (Collides(player.Extents, plat.Extents) == true && plat.currState != Platform.State.Crumbling) // dont want to be able to jump on a platform in crumbling state
				{
					
					if (player.Pos.Y + player.Extents.Height / 2 >= plat.Pos.Y - plat.Extents.Height / 2 && 
					    player.Pos.Y + player.Extents.Height / 2 <= plat.Pos.Y - plat.Extents.Height / 2 + 10 &&
					    player.currState != Player.PlayerState.Jumping) // fall-through allowance
					{
						player.GroundedSpeed = plat.ScrollSpeed;
						player.Grounded = true;
						player.currState = Player.PlayerState.Stationary;
						//set platform state to will fall
						if (player.JumpPower >= 0.9f)
							plat.WillFall = true;
						
						break;
					}
				}
				else
				{
					if (player.JumpPower < 0.9f)
						plat.WillFall = false;   //When the player falls off the platform at full power, the last platform he was on will not fall
					
					player.Grounded = false;
				}
			}
			
			//Player on powers
			
			foreach (Power pow in powers)
			{
				if (Collides(player.Extents, pow.Extents) == true && pow.currState != Power.State.Exploded)
				{
					if (player.Pos.Y + player.Extents.Height / 2 >= pow.Pos.Y - pow.Extents.Height / 2 && 
					    player.Pos.Y + player.Extents.Height / 2 <= pow.Pos.Y - pow.Extents.Height / 2 + 10 &&
					    player.currState != Player.PlayerState.Jumping) // fall-through allowance
					{
						player.GroundedSpeed = pow.ScrollSpeed;
						player.Grounded = true;
						player.currState = Player.PlayerState.Stationary;
						//set box to will explode
						if (player.JumpPower >= 0.9f)
							pow.WillExplode = true;
						
						break;
					}
				}
				else
				{
					if (player.JumpPower < 0.9f)
						pow.WillExplode = false; //when the player falls off the box at full power, the last box he was on will not explode
				}
			}
		}
		
		private static void CheckBulletCollisions()
		{	
			//Bullet offscreen
			
			foreach (Projectile proj in projectiles)
			{
				if (proj.Pos.X > graphics.Screen.Width)
					proj.Alive = false;
			}
			
			//Bullets on powers
			
			foreach (Projectile proj in projectiles)
			{
				foreach (Power pow in powers)
				{
					if (Collides(proj.Extents, pow.Extents) == true && pow.currState != Power.State.Exploded)
					{
						proj.Alive = false;
						pow.WillExplode = true;
					}
				}
			}
		}
		
		private static void CheckPowerCollisions()
		{
			//Powers on platforms
			
			foreach (Power pow in powers)
			{
				foreach (Platform plat in platforms)
				{
					if (Collides(pow.Extents, plat.Extents) == true)
					{
						pow.Grounded = true;	
						break;
					}
					else
						pow.Grounded = false;
				}
			}
		}
		
		private static bool Collides(Rectangle r1, Rectangle r2)
		{
			if (r1.Position.X + r1.Width / 2 < r2.Position.X - r2.Width / 2) 
				return false;
			if (r1.Position.X - r1.Width / 2 > r2.Position.X + r2.Width / 2)
				return false;
			if (r1.Position.Y + r1.Height / 2 < r2.Position.Y - r2.Height / 2)
				return false;
			if (r1.Position.Y - r1.Height / 2 > r2.Position.Y + r2.Height / 2)
				return false;
			
			return true;
		}
		
		#endregion
		
		
		
		
		
		#region Input
		
		private static void CheckPlayInput()
		{
			var gamePadData = GamePad.GetData(0);
			unpauseTimer += deltaTime;
			if (unpauseTimer >= 300)
			{
				if ((gamePadData.Buttons & GamePadButtons.Start) != 0)
				{
					pauseMenu = new PauseMenu(graphics);
					currState = GameState.Paused;
					unpauseTimer = 0;
				}
			}
		}
		
		private static void CheckMenuInput()
		{
			var gamePadData = GamePad.GetData(0);	 
			
			unpauseTimer += deltaTime;
			if (unpauseTimer >= 300)
			{
				if (mainMenu.menuState == MainMenu.MenuHighlights.StartGame && (gamePadData.Buttons & GamePadButtons.Start) != 0)
				{
					currState = GameState.Playing;
					StartGame();
					unpauseTimer = 0;
				}
			}

		}
		
		private static void CheckPauseInput()
		{
			var gamePadData = GamePad.GetData(0);
			unpauseTimer += deltaTime;
			if (unpauseTimer >= 300)
			{
				if (pauseMenu.pauseMenuState == PauseMenu.pauseMenuHighlights.Restart && (gamePadData.Buttons & GamePadButtons.Start) != 0)
				{
					StartGame ();
					currState = GameState.Playing;
					unpauseTimer = 0;
				}
				if (pauseMenu.pauseMenuState == PauseMenu.pauseMenuHighlights.Resume && (gamePadData.Buttons & GamePadButtons.Start) != 0)
				{
					currState = GameState.Playing;
					unpauseTimer = 0;
				}
				if (pauseMenu.pauseMenuState == PauseMenu.pauseMenuHighlights.Menu && (gamePadData.Buttons & GamePadButtons.Start) != 0)
				{	unpauseTimer = 0;
					mainMenu.menuState = MainMenu.MenuHighlights.StartGame;
					currState = GameState.Menu;
					
				}
			}
		}


		
		#endregion
		
		
		
		
		#region Garbage
		
		private static void CheckForDeadObjects()
		{
			if (platforms[totalPlatforms].Pos.X < -56)
			{
				for (int z = totalPlatforms; z >= 0; z--)
				{
					platforms[z].Alive = false;
					platforms.RemoveAt(z);
					difficultyCounter++;
					Console.WriteLine(debug ? "Difficulty Counter: " +difficultyCounter : null);
				}
			}
			
			for (int i = projectiles.Count - 1; i >= 0; i--)
			{
				if (projectiles[i].Alive == false)
				{
					projectiles.RemoveAt(i);	
				}
			}
			
			foreach (Power pow in powers)
			{
				if (pow.Pos.X < -52)
					pow.Alive = false;
			}
			
			for (int i = powers.Count - 1; i >= 0; i--)
			{
				if (powers[i].Alive == false)
					powers.RemoveAt(i);
			}
		}
		
		#endregion
		
		
		
		
		#region Rendering

		public static void Render ()
		{
			switch (currState)
			{
			case GameState.Menu: RenderMenu(); break;
			case GameState.Playing: RenderPlaying(); break;
			case GameState.Paused:  RenderPlaying(); break;
			}
		}
		
		private static void RenderMenu()
		{
			// Clear the screen
			graphics.SetClearColor (0.0f, 0.0f, 0.0f, 0.0f);
			graphics.Clear ();
			
			mainMenu.Render();
			
			// Present the screen
			graphics.SwapBuffers ();
		}
		
		private static void RenderPlaying()
		{
			// Clear the screen
			graphics.SetClearColor (0.0f, 0.0f, 0.0f, 0.0f);
			graphics.Clear ();
			
			background.Render();
			midground.Render();
			hudBar.Render();
			foreach (Platform ter in platforms)
			{
				ter.Render();	
			}
			foreach (Power pow in powers)
			{
				pow.Render();	
			}
			scoreLabel.Render();
			playerJumpPowerBar.Render();
			playerChargePowerBar.Render();
			player.Render();
			foreach (Projectile p in projectiles)
			{
				p.Render();	
			}
			
			if (currState == GameState.Paused)
				RenderPaused();
			
			// Present the screen
			graphics.SwapBuffers ();
		}
		
		private static void RenderPaused()
		{
			pauseMenu.Render();
		}
		
		#endregion
	}
}
